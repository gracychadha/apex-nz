class TemplateParser{newStr="";constructor(e,t,r){this.expressions=r??{},this.init(e,t)}init(e,t){let r=(this.query(e)||{}).outerHTML;r&&(r=r.replace(/[\n\r]+/g,""),r=this.loopHandler(this.getExpressionList(r.replace(/giimall-a/g,"a")),t),this.newStr=this.repalceExpression(r,t).replace(/{[^}]+}/g,""))}getExpressionList(e){let t=[],r="";if(/m:(if|for)/.test(e))for(e=e.replace(/(<\/template>)/g,"$1\n").replace(/(<template)/g,"\n$1");/m:(if|for)/.test(e);)e=e.replace(/^<template[\s\n]*m:(if|for)\s?=\s?"([^"]+)"([^>]*)>([^\n]+)<\/template>$/m,(e,n,s,i,l)=>{const a=-1!=i.indexOf("key")?/key="([^"]+)"/.exec(i)[1]:"";return s=s.replace(/\s/g,"_"),t.push({content:l,type:n,exp:s,indexName:a}),r=`<${s}/>`,r}).replace(`\n${r}\n`,r);return[e,t]}loopHandler([e,t],r){let n=t.length-1;for(;n>=0&&t[n];){const s=t.pop();switch(s.type){case"for":const n=s.exp.split("_in_"),i=this.getValue(r,n[1]);e=e.replace(`<${s.exp}/>`,i&&i.length?i.map((e,r)=>{let i=this.repalceExpression(s.content,e);return i=this.loopHandler([i,t.slice(0)],{[n[0]]:e}),s.indexName?i.replaceAll(new RegExp(`{${s.indexName}([^}]*)}`,"g"),r):i}).join(""):""),t=[];break;case"if":e=e.replace(`<${s.exp}/>`,this.repalceExpression(this.conditionHandler(r,s.exp,s.content),r))}n--}return e}conditionHandler(e,t,r){const n=/[\s_]{1}eq[\s_]{1}/;if(n.test(t)){var s=t.split(n),i=this.getValue(e,s[0]),l=s[1].slice(1,-1);return/^\d+$/.test(l)&&(l=Number(l)),i==l?r:""}return(i=this.getValue(e,t))&&i.toString()?r??i:""}repalceExpression(e,t){return""==e||null==e?"":(/{[^}]+}/.test(e)&&(e=e.replace(/{([^}]+)}/g,(r,n)=>{let s=new RegExp(`data-clean-html\\s?=\\s?"${n.substring(n.indexOf(".")+1)}"`),i=!1;return s.test(e)&&(e=e.replace(s,""),i=!0),1!=/[\s_]{1}eq[\s_]{1}/.test(n)?this.getValue(t,n,void 0,i)||r:this.conditionHandler(t,n)})),/m:bind/.test(e)&&(e=e.replace(/m:bind:([\w]+)="([^"]*)"/,(e,r,n)=>{if(/\?|:/.test(n)){const[e,s,i]=n.split(/\s?\?\s?|\s?:\s?/);return`${r}="${this.getValue(t,e)?s:i}"`}})),e)}getValue(e,t,r,n){if(t){if(t!=r){if(/\[([^\]]+)\]/.test(t)&&(t=t.replace(/\['?([^\]']+)'?\]/g,".$1")),r&&(t=t.substring(t.indexOf(".")+1)),-1!=t.indexOf(".")){let r=t.split("."),s="",i=r.length;for(let t=0;t<i;t++)s=s?s[r[t]]:e[r[t]];return this.valueDecorate(s,r[i-1],n)}return this.valueDecorate(e[t],t,n)}return e||""}return""}valueDecorate(e,t,r){const n=this.expressions[t];if(null!=e&&r){const t=document.createElement("main");t.innerHTML=e,e=t.textContent}if(null==n)return e??"";{const[t,r]=n.split(":");return e!=t?e??"":r??""}}query(e){return"string"==typeof e?/<\/\w+>|<[^/>]\/>/.test(e)?e:document.querySelector(e):e}innerStyle(e){return`style = "${Object.keys(e).map(t=>{const r=e[t];return`${t}:${"number"!=typeof r?r:r+"px"}`}).join(";")}"`}getHTMLString(){return/<template\s*>/.test(this.newStr)?this.newStr.substring(this.newStr.indexOf(">")+1):this.newStr}}